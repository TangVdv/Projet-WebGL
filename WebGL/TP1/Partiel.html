<!DOCTYPE html>
<html lang="en">
	<head>
		<title>three.js webgl - FBX loader</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

	</head>

	<body>
		<div id = "overlay_video" class="d-flex justify-content-center" >
			<video id="video" width="1600" style="display:none" muted>
	  		<source src="video/bomb.mp4" type="video/mp4">
					Your browser does not support the video tag.
			</video>
		</div>

		<div id="container">
			<script type="module">

				import * as THREE from '../three.js-master/build/three.module.js';

				import Stats from '../three.js-master/examples/jsm/libs/stats.module.js';

				import { GUI } from '../three.js-master/examples/jsm/libs/dat.gui.module.js';

				import { OrbitControls } from '../three.js-master/examples/jsm/controls/OrbitControls.js';
				import  { FirstPersonControls } from '../three.js-master/examples/jsm/controls/FirstPersonControls.js';
				import { FBXLoader } from '../three.js-master/examples/jsm/loaders/FBXLoader.js';

	      import { MTLLoader } from '../three.js-master/examples/jsm/loaders/MTLLoader.js';
	      import { OBJLoader } from '../three.js-master/examples/jsm/loaders/OBJLoader.js';
				import { GLTFLoader } from '../three.js-master/examples/jsm/loaders/GLTFLoader.js';

				import { Octree } from '../three.js-master/examples/jsm/math/Octree.js';
				import { Capsule } from '../three.js-master/examples/jsm/math/Capsule.js';

				let camera, scene, renderer, stats;
				let gui, controls, controls_2;
				//let gui;

				const clock = new THREE.Clock();

				let mixer;
				let fog = 0;
	      let shrekPosition;
				let Rshrek, Rmissile, Rmap;
				let Opos;
				let video, Vstatus;

				const GRAVITY = 30;

				const STEPS_PER_FRAME = 5;

				const worldOctree = new Octree();

				const playerCollider = new Capsule( new THREE.Vector3( 0, 0.35, 0 ), new THREE.Vector3( 0, 1, 0 ), 0.35 );

				const playerVelocity = new THREE.Vector3();
				const playerDirection = new THREE.Vector3();

				document.addEventListener( 'keydown', ( event ) => {

				keyStates[ event.code ] = true;

			} );

			document.addEventListener( 'keyup', ( event ) => {

				keyStates[ event.code ] = false;

			} );

			document.body.addEventListener( 'mousemove', ( event ) => {

				if ( document.pointerLockElement === document.body ) {

					camera.rotation.y -= event.movementX / 500;
					camera.rotation.x -= event.movementY / 500;

				}

			} );

				let playerOnFloor = false;
				let mouseTime = 0;

				const keyStates = {};

				function setup(){

					camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 1, 50000 );
					camera.position.set( 100, 800, -200 );

					renderer = new THREE.WebGLRenderer( { antialias: true } );
					renderer.setPixelRatio( window.devicePixelRatio );
					renderer.setSize( window.innerWidth, window.innerHeight );
					renderer.shadowMap.enabled = true;
					container.appendChild( renderer.domElement );

					window.addEventListener( 'resize', onWindowResize );

					// stats
					stats = new Stats();
					container.appendChild( stats.dom );
				}
				setup();

				init();
				//animate();



				function init() {
					const container = document.getElementById('container');

					scene = new THREE.Scene();
					scene.background = new THREE.Color( 0xa0a0a0 );
					scene.fog = new THREE.Fog( 0xa0a0a0, 12000, 15000 );

					const hemiLight = new THREE.HemisphereLight( 0xffffff, 0x444444 );
					hemiLight.position.set( 0, 200, 0 );
					scene.add( hemiLight );

					const light = new THREE.PointLight( 0xffffff, .33, 10000 );
					light.position.set( 1000, 2000, 1000 );
					light.castShadow = true;
					light.shadow.mapSize.width = 2048; //Qualité de l'ombre en largeur
					light.shadow.mapSize.height = 2048; //Qualité de l'ombre en hauteur
					scene.add( light );

					//Video setup
					video = document.getElementById( 'video' );
					Vstatus = 0;
					//video.play();

					Opos = 1500;
					camera.position.y += Opos;
					//1000 1500

					// ground
					const mesh = new THREE.Mesh( new THREE.PlaneGeometry( 2000, 2000 ), new THREE.MeshPhongMaterial( { color: 0x999999, depthWrite: false } ) );
					mesh.rotation.x = - Math.PI / 2;
					mesh.receiveShadow = true;
					scene.add( mesh );

	        shrekPosition = 100;

					createShrek();

	        createRocket();

					//buildCityClean();
					buildCityDestroyed();

					setupControls();
					controls_2.enabled = false;


					animate();
				}

				function Volcan(){
					const container = document.getElementById('container');

					scene = new THREE.Scene();
					scene.background = new THREE.Color( 0xa0a0a0 );
					scene.fog = new THREE.Fog( 0xa0a0a0, 12000, 15000 );

					const hemiLight = new THREE.HemisphereLight( 0xffffff, 0x444444 );
					hemiLight.position.set( 0, 200, 0 );
					scene.add( hemiLight );

					const light = new THREE.PointLight( 0xffffff, .33, 10000 );
					light.position.set( 1000, 2000, 1000 );
					light.castShadow = true;
					light.shadow.mapSize.width = 2048; //Qualité de l'ombre en largeur
					light.shadow.mapSize.height = 2048; //Qualité de l'ombre en hauteur
					scene.add( light );

					// ground
					const mesh = new THREE.Mesh( new THREE.PlaneGeometry( 2000, 2000 ), new THREE.MeshPhongMaterial( { color: 0x999999, depthWrite: false } ) );
					mesh.rotation.x = - Math.PI / 2;
					mesh.receiveShadow = true;
					scene.add( mesh );

					setupControls();
					controls_2.enabled = false;

					//createKenshiro();
					//createSaitama();

					buildVolcanMap();

					animate();
				}



				function setupControls(){
					// CONTROL

					controls = new OrbitControls( camera, renderer.domElement );
					controls.addEventListener( 'change', renderer );
					controls.minDistance = 100;
					controls.maxDistance = 20000;
					controls.enablePan = false;
					controls.enabled = true;

					controls_2 = new FirstPersonControls(camera, renderer.domElement);
	        controls_2.movementSpeed = 1000;
	        controls_2.lookSpeed = 0.1;
	        controls_2.lookVertical = true;
				}

				function createShrek(){

					// model shrek
					const loader = new FBXLoader();
					loader.load( 'models/shrekPose.fbx', function ( shrek ) {

						mixer = new THREE.AnimationMixer( shrek );
						Rshrek = shrek;

	          shrek.position.y = Opos + shrekPosition;
	          shrek.scale.set(7, 7, 7);

						shrek.rotation.x = 1;

						const action = mixer.clipAction( shrek.animations[ 0 ] );
						action.play();

						shrek.traverse( function ( child ) {

							if ( child.isMesh ) {

								child.castShadow = true;
								child.receiveShadow = true;

							}

						} );


						scene.add( shrek );
					} );
				}

				function createRocket(){
					//model fusé

	        const missileLoader = new FBXLoader();
					missileLoader.load( 'models/missile.fbx', function ( missile ) {

						//mixer = new THREE.AnimationMixer( missile );
						//Rmissile = missile;

	          missile.position.y =  Opos + shrekPosition-30;
	          missile.scale.set(0.3, 0.3, 0.3);

						missile.rotation.x = 1;

						//const action = mixer.clipAction( missile.animations[ 0 ] );
						//action.play();

						missile.traverse( function ( child ) {

							if ( child.isMesh ) {

								child.castShadow = true;
								child.receiveShadow = true;

							}

						} );


						scene.add( missile );
						Rmissile = missile;
					} );
				}

	      function buildVolcanMap() {
					new MTLLoader().setPath( 'models/maps/' ).load( 'Planet_Destroyed.mtl', function ( materials ) {
							materials.preload();

							new OBJLoader()
							.setMaterials( materials )
							.setPath( 'models/maps/' )
							.load( 'Planet_Destroyed.obj', function ( planet ) {
								scene.add( planet );
								planet.scale.set(10,10,10);

								planet.traverse( function ( child ) {
									if ( child.isMesh ) {
										child.castShadow = true;
										child.receiveShadow = true;
									}
								} );

							} );
					} );
				}

				function createKenshiro() {
					let loader = new GLTFLoader();

					loader.load('models/kenshiro_final.glb', function ( kenshiro ) {

							scene.add( kenshiro.scene );
							kenshiro.scene.scale.set(5,5,5);

							kenshiro.scene.traverse( function ( child ) {
								if ( child.isMesh ) {
									child.castShadow = true;
									child.receiveShadow = true;
								}
							});

							//gltf.animations; // Array<THREE.AnimationClip>
							gltf.scene; // THREE.Group
							gltf.scenes; // Array<THREE.Group>
							gltf.cameras; // Array<THREE.Camera>
							gltf.asset; // Object

						});
					}

				function createSaitama() {
						let loader = new GLTFLoader();

						loader.load('models/test/Saitama_30.glb', function ( saitama ) {
								let mixer = new THREE.AnimationMixer(saitama);

								const actionSaitama = mixer.clipAction(saitama.animations[0]);
				        actionSaitama.play();

								scene.add( saitama.scene );
								saitama.scene.scale.set(1.4,1.4,1.4);
								saitama.scene.position.set(0, 0, 100);
								saitama.scene.rotation.y = Math.PI;

								saitama.scene.traverse( function ( child ) {
									if ( child.isMesh ) {
										child.castShadow = true;
										child.receiveShadow = true;
									}
								});

								gltf.animations; // Array<THREE.AnimationClip>
								gltf.scene; // THREE.Group
								gltf.scenes; // Array<THREE.Group>
								gltf.cameras; // Array<THREE.Camera>
								gltf.asset; // Object

							});
					}

				function buildCityClean() {
						let loader = new GLTFLoader();

						loader.load('models/maps/City_clean/City_clean.glb', function ( city_clean ) {

								scene.add( city_clean.scene );
								city_clean.scene.scale.set(5,5,5);
							  city_clean.name = "map";

								city_clean.scene.traverse( function ( child ) {
									if ( child.isMesh ) {
										child.castShadow = true;
										child.receiveShadow = true;
									}
								});

								//gltf.animations; // Array<THREE.AnimationClip>
								gltf.scene; // THREE.Group
								gltf.scenes; // Array<THREE.Group>
								gltf.cameras; // Array<THREE.Camera>
								gltf.asset; // Object

							});
						}

						function buildCityDestroyed() {
							let loader = new GLTFLoader();

							loader.load('models/maps/City_destroyed/City_destroyed.gltf', function ( city_destroyed ) {

									scene.add( city_destroyed.scene );
									city_destroyed.scene.scale.set(50,50,50);

									city_destroyed.scene.traverse( function ( child ) {
										if ( child.isMesh ) {
											child.castShadow = true;
											child.receiveShadow = true;
										}
									});

									//gltf.animations; // Array<THREE.AnimationClip>
									gltf.scene; // THREE.Group
									gltf.scenes; // Array<THREE.Group>
									gltf.cameras; // Array<THREE.Camera>
									gltf.asset; // Object

								});
							}

				function startVideo(){
					Vstatus = 1;
					//console.log("ok");
					container.style.display = 'none';
					video.style.display = 'block';
					video.play();
					setTimeout( stopVideo, 7000 );
				}

				function stopVideo(){
					const overlay_video = document.getElementById('overlay_video');
					overlay_video.remove();
					container.style.display = 'block';
					while (scene.children.length)
					    scene.remove(scene.children[0]);

					Volcan();
				}


				function onWindowResize() {

					camera.aspect = window.innerWidth / window.innerHeight;
					camera.updateProjectionMatrix();

					renderer.setSize( window.innerWidth, window.innerHeight );

				}

				//

				function animate() {

					requestAnimationFrame( animate );

					const delta = clock.getDelta();

					if ( mixer ) mixer.update( delta );
					if (controls_2) controls_2.update(delta);

					if (Rshrek) Rshrek.position.y -= 20;
					if (Rmissile) Rmissile.position.y -= 20;
					//camera.position.y -= 2;


					if(Vstatus == 0){ // Has video already been played?
						if(Rshrek.position.y < 100){
							startVideo();
						}
					}

					renderer.render( scene, camera );

					stats.update();

				}

			</script>
		</div>
	</body>
</html>
